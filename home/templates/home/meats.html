{% extends "home/base.html" %}
{% load static %}

{% block content %}
<style>
    .meat-text {
        color: #fdb417;
    }
    .vertical-filter-box {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        background: white;
        border-radius: 8px;
        padding: 0;
    }
    .all-filter-btn {
        text-align: left;
        width: 100%;
        padding: 15px 20px;
        background: #fdb417;
        border: none;
        color: white;
        font-weight: 500;
        border-radius: 8px 8px 0 0;
    }
    .filter-group {
        border-bottom: 1px solid #eee;
    }
    .filter-toggle {
        width: 100%;
        text-align: left;
        padding: 12px 20px;
        background: none;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #444;
        cursor: pointer;
    }
    .filter-toggle:hover {
        background-color: #fff8e8;
    }
    .filter-toggle.active {
        background-color: #fdb417;
        color: white;
    }
    .filter-options {
        display: none;
        background: #f9f9f9;
    }
    .filter-group.open > .filter-options {
        display: block;
    }
    .toggle-arrow {
        transition: transform 0.3s;
        color: #fdb417;
    }
    .filter-toggle.active .toggle-arrow {
        color: white;
    }
    .filter-group.open > .filter-toggle .toggle-arrow {
        transform: rotate(180deg);
    }
    .subcategory-group {
        padding: 8px 0;
    }
    .subcategory-item {
        padding: 8px 20px 8px 40px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .subcategory-item:hover {
        background-color: #fff8e8;
    }
    .subcategory-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        border: 2px solid #fdb417;
        border-radius: 3px;
        display: inline-block;
        position: relative;
        cursor: pointer;
    }
    .subcategory-checkbox.checked {
        background-color: #fdb417;
    }
    .subcategory-checkbox.checked::after {
        content: 'âœ“';
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
    }
    #vertical-filter {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
    #subcategories-container {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
    }
</style>

<br>
<br>
<br>
<br>
<br>

<div class="desktop-view-products">
    <section id="portfolio" class="portfolio col-lg-12">
        <div class="container">
            <section id="portfolio" class="portfolio">
                <div class="container first-filter">
                    {% comment %} <div class="section-title" data-aos="fade-up">
                        <h2>Products</h2>
                        <p>Check out our products</p>
                    </div> {% endcomment %}
                    <div class="row" data-aos="fade-up" data-aos-delay="100">
                    </div>
                    <span class="icon-span">
                        <div class="col-lg-9">
                            <ul id="portfolio-flters1">
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'meats' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/all.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>All</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    <a href="{% url 'meats' %}">
                                        <li>
                                            <div class="icon-container">
                                                <img src="{% static 'img/icons/2.svg' %}" class="filter-icon meat-icon"
                                                    alt="All Icon" width="30" height="30" />
                                                <p class="meat-text">Meat</p>
                                            </div>
                                        </li>
                                    </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'dairy' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/Dairy.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Dairy</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'oils' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/oils2.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Oils</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'others' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/others.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Others</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                            </ul>
                        </div>
                    </span>
                </div>
            </section>
            {% comment %} <div class="section-title" data-aos="fade-up">
                <p>Check out our diverse products</p>
            </div>
            {% endcomment %}
            <div class="row inner-filter">
                <div>
                    <ul id="portfolio-flters">
                        <li data-filter="*">
                            <div class="icon-container">
                                <img src="{% static 'img/icons/all.svg' %}" class="filter-icon" 
                                     alt="All Icon" width="30" height="30" />
                            </div>
                            <p>All</p>
                        </li>
                        {% for category in main_categories %}
                        <!-- Debug info -->
                        {% if debug %}
                        <!-- Category ID: {{ category.id }}, Name: {{ category.name }}, Filter class: {{ category.filter_class }} -->
                        {% endif %}
                        <li data-filter=".{{ category.filter_class }}" 
                            data-category-id="{{ category.id }}" 
                            {% if forloop.first %}class="filter-active"{% endif %}
                            onclick="console.log('Category clicked:', {{ category.id }})">
                            <div class="icon-container">
                                <img src="{{ category.icon.url }}" class="filter-icon" 
                                     alt="{{ category.name }} Icon" width="30" height="30" />
                            </div>
                            <p>{{ category.name }}</p>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="row portfolio-container" data-aos="fade-up" data-aos-delay="200">
                <div class="col-lg-3">
                    <div id="vertical-filter" class="vertical-filter-box">
                        <button class="all-filter-btn">
                            All Categories
                        </button>
                        <div id="subcategories-container">
                            {% if debug %}
                            <!-- Debug info for categories -->
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-lg-9">
                    <div class="row">
                        {% for product in products %}
                        <!-- Debug: Product {{ product.name }} - Category: {{ product.category.name }} - Filter Class: {{ product.category.filter_class }} -->
                        <div class="col-lg-4 col-md-6 portfolio-item {{ product.category.filter_class }} {% if product.category.parent %}{{ product.category.parent.filter_class }}{% endif %} {% if product.category.parent.parent %}{{ product.category.parent.parent.filter_class }}{% endif %}">
                            <div class="portfolio-wrap">
                                <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}" width="400" height="300">
                                <div class="portfolio-links">
                                    <a href="{{ product.shop_link }}" title="Shop now"><i class="icofont-link"></i></a>
                                </div>
                                <div class="portfolio-info">
                                    <h4>{{ product.name }}</h4>
                                    <p>{{ product.description }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End Portfolio Section -->
</div>
{% include 'home/mobile/meats.html' %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const portfolioContainer = document.querySelector('.portfolio-container');
        const iso = new Isotope(portfolioContainer, {
            itemSelector: '.portfolio-item'
        });

        let currentMainCategory = '*';
        let activeSubcategories = new Set();

        function updateFiltering() {
            let filterValue;
            
            // Debug logging
            console.log('Current main category:', currentMainCategory);
            console.log('Active subcategories:', Array.from(activeSubcategories));
            
            if (currentMainCategory === '*') {
                // If "All" is selected, only apply subcategory filters
                filterValue = activeSubcategories.size > 0 
                    ? Array.from(activeSubcategories).join(', ')
                    : '*';
            } else {
                if (activeSubcategories.size > 0) {
                    // When subcategories are selected, show items that match the main category
                    // OR match any of the selected subcategories
                    const subcatFilters = Array.from(activeSubcategories).join(', ');
                    filterValue = subcatFilters;
                } else {
                    // If no subcategories selected, show all items from main category
                    filterValue = currentMainCategory;
                }
            }
            
            console.log('Applying filter:', filterValue);
            
            // Debug: Log all available items and their classes
            document.querySelectorAll('.portfolio-item').forEach(item => {
                console.log('Item classes:', item.className);
            });
            
            iso.arrange({ filter: filterValue });
            
            // Debug: Log how many items are visible after filtering
            const visibleItems = document.querySelectorAll(filterValue === '*' ? '.portfolio-item' : filterValue.split(', ').map(f => '.portfolio-item' + f).join(', '));
            console.log('Visible items after filter:', visibleItems.length);
        }

        // Load subcategories when a main category is clicked
        document.querySelectorAll('#portfolio-flters li[data-category-id]').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const categoryId = this.dataset.categoryId;
                
                // Update active state
                document.querySelectorAll('#portfolio-flters li').forEach(el => {
                    el.classList.remove('filter-active');
                });
                this.classList.add('filter-active');
                
                // Update current main category filter
                currentMainCategory = this.getAttribute('data-filter') || '*';
                // Clear active subcategories when changing main category
                activeSubcategories.clear();
                updateFiltering();
                
                loadSubcategories(categoryId);
            });
        });

        function createSubcategoryItem(subcat, parentFilterClass) {
            const item = document.createElement('div');
            item.className = 'subcategory-item';
            item.dataset.categoryId = subcat.id;
            item.dataset.filterClass = '.' + subcat.filter_class;
            
            const checkbox = document.createElement('span');
            checkbox.className = 'subcategory-checkbox';
            
            const label = document.createElement('span');
            label.textContent = subcat.name;
            
            item.appendChild(checkbox);
            item.appendChild(label);
            
            item.addEventListener('click', function() {
                const isChecked = checkbox.classList.toggle('checked');
                const filterClass = this.dataset.filterClass;
                
                if (isChecked) {
                    activeSubcategories.add(filterClass);
                } else {
                    activeSubcategories.delete(filterClass);
                }
                
                updateFiltering();
            });
            
            return item;
        }

        function loadSubcategories(categoryId) {
            const container = document.getElementById('subcategories-container');
            
            fetch(`/get_subcategories/${categoryId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    container.innerHTML = ''; // Clear existing subcategories
                    
                    if (data.subcategories && data.subcategories.length > 0) {
                        data.subcategories.forEach(subcat => {
                            const filterGroup = document.createElement('div');
                            filterGroup.className = 'filter-group';
                            
                            const buttonContent = `
                                <button class="filter-toggle" data-category-id="${subcat.id}" data-filter-class="${subcat.filter_class}">
                                    <span>${subcat.name}</span>
                                    ${subcat.has_children ? '<i class="fas fa-chevron-down toggle-arrow"></i>' : ''}
                                </button>
                                <div class="filter-options">
                                    <div class="subcategory-container-${subcat.id} subcategory-group"></div>
                                </div>
                            `;
                            
                            filterGroup.innerHTML = buttonContent;
                            container.appendChild(filterGroup);

                            // Add click event for the new filter toggle
                            const toggle = filterGroup.querySelector('.filter-toggle');
                            toggle.addEventListener('click', function(e) {
                                e.preventDefault();
                                const group = this.closest('.filter-group');
                                group.classList.toggle('open');
                                
                                if (subcat.has_children && group.classList.contains('open')) {
                                    // Load sub-subcategories
                                    fetch(`/get_subcategories/${subcat.id}/`)
                                        .then(response => response.json())
                                        .then(subData => {
                                            const subContainer = group.querySelector(`.subcategory-container-${subcat.id}`);
                                            subContainer.innerHTML = '';
                                            subData.subcategories.forEach(subSubcat => {
                                                // Pass both the sub-subcategory's filter class and its parent's filter class
                                                const subItem = createSubcategoryItem(subSubcat, subcat.filter_class);
                                                subContainer.appendChild(subItem);
                                            });
                                        });
                                }
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading subcategories:', error);
                });
        }

        // Initial load of subcategories for the first main category
        const firstCategory = document.querySelector('#portfolio-flters li[data-category-id]');
        if (firstCategory) {
            firstCategory.classList.add('filter-active');
            currentMainCategory = firstCategory.getAttribute('data-filter') || '*';
            loadSubcategories(firstCategory.dataset.categoryId);
        }

        // Add click handler for "All Categories" button
        document.querySelector('.all-filter-btn').addEventListener('click', function() {
            currentMainCategory = '*';
            activeSubcategories.clear();
            updateFiltering();
            
            // Update active state in main categories
            document.querySelectorAll('#portfolio-flters li').forEach(el => {
                el.classList.remove('filter-active');
            });
            document.querySelector('#portfolio-flters li[data-filter="*"]').classList.add('filter-active');
        });
    });
</script>

{% endblock %}