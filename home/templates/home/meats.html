{% extends "home/base.html" %}
{% load static %}

{% block content %}
<style>
  

    .meat-text {
        color: #fdb417;
    }
    .meat-icon {
        filter: invert(72%) sepia(32%) saturate(2385%) hue-rotate(359deg) brightness(103%) contrast(106%);
    }
    .vertical-filter-box {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        background: white;
        border-radius: 8px;
        padding: 0;
    }
    .vertical-filter-container {
        margin-left: -300px;
        margin-bottom: 1%;
    }
    .all-filter-btn {
        text-align: left;
        width: 100%;
        padding: 15px 20px;
        background: none;
        border: none;
        color: #444;
        font-weight: 500;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .all-filter-btn:hover {
        background-color: #fdb417;
    }
    .all-filter-btn.active {
        background: #fdb417;
        color: white;
    }
    .filter-group {
        border-bottom: 1px solid #eee;
    }
    .filter-toggle {
        width: 100%;
        text-align: left;
        padding: 12px 20px;
        background: none;
        border: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: #444;
        cursor: pointer;
        margin-top: 5px;
        margin-bottom: 5px;
    }
    .filter-toggle:hover {
        background-color: #fdb417;
    }
    .filter-toggle.active {
        background-color: #fdb417;
        color: white;
    }
    .filter-options {
        display: none;
        background: #f9f9f9;
    }
    .filter-group.open > .filter-options {
        display: block;
    }
    .toggle-arrow {
        transition: transform 0.3s;
        color: #fdb417;
    }
    .filter-toggle.active .toggle-arrow {
        color: white;
    }
    .filter-group.open > .filter-toggle .toggle-arrow {
        transform: rotate(180deg);
    }
    .subcategory-group {
        padding: 8px 0;
    }
    .subcategory-item {
        padding: 8px 20px 8px 40px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }
    .subcategory-item:hover {
        background-color: #fff8e8;
    }
    .subcategory-checkbox {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        border: 2px solid #fdb417;
        border-radius: 3px;
        display: inline-block;
        position: relative;
        cursor: pointer;
    }
    .subcategory-checkbox.checked {
        background-color: #fdb417;
    }
    .subcategory-checkbox.checked::after {
        content: 'âœ“';
        color: white;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 12px;
    }
    #vertical-filter {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
    #subcategories-container {
        max-height: calc(100vh - 150px);
        overflow-y: auto;
    }
</style>

<br>
<br>
<br>
<br>
<br>

<div class="desktop-view-products">
    <section id="portfolio" class="portfolio col-lg-12">
        <div class="container">
            <section id="portfolio" class="portfolio">
                <div class="container first-filter">
                    {% comment %} <div class="section-title" data-aos="fade-up">
                        <h2>Products</h2>
                        <p>Check out our products</p>
                    </div> {% endcomment %}
                    <div class="row" data-aos="fade-up" data-aos-delay="100">
                    </div>
                    <span class="icon-span">
                        <div class="col-lg-9">
                            <ul id="portfolio-flters1">
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'meats' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/all.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>All</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    <a href="{% url 'meats' %}">
                                        <li>
                                            <div class="icon-container">
                                                <img src="{% static 'img/icons/2.svg' %}" class="filter-icon meat-icon"
                                                    alt="Meat Icon" width="30" height="30" />
                                                <p class="meat-text">Meat</p>
                                            </div>
                                        </li>
                                    </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'dairy' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/Dairy.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Dairy</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'oils' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/oils2.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Oils</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                                <span class="icon-span">
                                    {% comment %} <a href="{% url 'others' %}"> {% endcomment %}
                                        <a href="#">
                                            <li>
                                                <div class="icon-container">
                                                    <img src="{% static 'img/icons/others.svg' %}" class="filter-icon"
                                                        alt="All Icon" width="30" height="30" />
                                                    <p>Others</p>
                                                </div>
                                            </li>
                                        </a>
                                </span>
                            </ul>
                        </div>
                    </span>
                </div>
            </section>
            {% comment %} <div class="section-title" data-aos="fade-up">
                <p>Check out our diverse products</p>
            </div>
            {% endcomment %}
            <div class="row inner-filter">
                <div>
                    <ul id="portfolio-flters">
                        <li data-filter="*">
                            <div class="icon-container">
                                <img src="{% static 'img/icons/all.svg' %}" class="filter-icon" 
                                     alt="All Icon" width="30" height="30" />
                            </div>
                            <p>All</p>
                        </li>
                        {% for category in main_categories %}
                        <!-- Debug info -->
                        {% if debug %}
                        <!-- Category ID: {{ category.id }}, Name: {{ category.name }}, Filter class: {{ category.filter_class }} -->
                        {% endif %}
                        <li data-filter=".{{ category.filter_class }}" 
                            data-category-id="{{ category.id }}">
                            <div class="icon-container">
                                <img src="{{ category.icon.url }}" class="filter-icon" 
                                     alt="{{ category.name }} Icon" width="30" height="30" />
                            </div>
                            <p>{{ category.name }}</p>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <div class="row portfolio-container" data-aos="fade-up" data-aos-delay="200">
                <div class="col-lg-3 vertical-filter-container">
                    <div id="vertical-filter" class="vertical-filter-box">
                        <button class="all-filter-btn">
                            All Categories
                        </button>
                        <div id="subcategories-container">
                            {% if debug %}
                            <!-- Debug info for categories -->
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="col-lg-12">
                    <div class="row">
                        {% for product in products %}
                        <!-- Debug: Product {{ product.name }} - Category: {{ product.category.name }} - Filter Class: {{ product.category.filter_class }} -->
                        <div class="col-lg-4 col-md-6 portfolio-item {{ product.category.filter_class }} {% if product.category.parent %}{{ product.category.parent.filter_class }}{% endif %} {% if product.category.parent.parent %}{{ product.category.parent.parent.filter_class }}{% endif %}">
                            <div class="portfolio-wrap">
                                <img src="{{ product.image.url }}" class="img-fluid" alt="{{ product.name }}" width="400" height="300">
                                <div class="portfolio-links">
                                    <a href="{{ product.shop_link }}" title="Shop now"><i class="icofont-link"></i></a>
                                </div>
                                <div class="portfolio-info">
                                    <h4>{{ product.name }}</h4>
                                    <p>{{ product.description }}</p>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- End Portfolio Section -->
</div>
{% include 'home/mobile/meats.html' %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const portfolioContainer = document.querySelector('.portfolio-container');
        const iso = new Isotope(portfolioContainer, {
            itemSelector: '.portfolio-item'
        });

        let currentMainCategory = '*';
        let activeSubcategories = new Set();
        let selectedMainCategoryId = null;
        const allCategoriesBtn = document.querySelector('.all-filter-btn');

        // Add click handler for All Categories button
        allCategoriesBtn.addEventListener('click', function() {
            // Clear all active subcategories
            activeSubcategories.clear();
            
            // Remove checked state from all subcategory checkboxes
            document.querySelectorAll('.subcategory-checkbox').forEach(checkbox => {
                checkbox.classList.remove('checked');
            });
            
            // Add active class to All Categories button
            this.classList.add('active');
            
            // Update the filtering to show all items
            if (currentMainCategory === '*') {
                iso.arrange({ filter: '*' });
            } else {
                iso.arrange({ filter: currentMainCategory });
            }
        });

        function updateFiltering() {
            let filterValue;
            
            if (currentMainCategory === '*') {
                // If "All" is selected, only use subcategory filters
                filterValue = activeSubcategories.size > 0 ? 
                    Array.from(activeSubcategories).join(', ') : '*';
            } else {
                // If a main category is selected, combine it with subcategory filters
                if (activeSubcategories.size > 0) {
                    // Create an array of combined filters
                    const combinedFilters = Array.from(activeSubcategories).map(subFilter => 
                        `${currentMainCategory}${subFilter}`
                    );
                    filterValue = combinedFilters.join(', ');
                } else {
                    // If no subcategories selected, show all items from current main category
                    filterValue = currentMainCategory;
                }
            }
            
            console.log('Applying filter:', filterValue);
            iso.arrange({ filter: filterValue });
        }

        // Handle main category filter clicks
        document.querySelectorAll('#portfolio-flters li').forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update active state
                document.querySelectorAll('#portfolio-flters li').forEach(el => {
                    el.classList.remove('filter-active');
                });
                this.classList.add('filter-active');
                
                // Update current main category filter
                currentMainCategory = this.getAttribute('data-filter') || '*';
                selectedMainCategoryId = this.dataset.categoryId || null;
                
                // Clear active subcategories when changing main category
                activeSubcategories.clear();
                
                // Always load subcategories, even for "All" category
                if (currentMainCategory === '*') {
                    loadAllSubcategories();
                } else if (selectedMainCategoryId) {
                    loadSubcategories(selectedMainCategoryId);
                }
                
                // Update filtering
                updateFiltering();
            });
        });

        function loadAllSubcategories() {
            fetch('/get_all_subcategories/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('subcategories-container');
                    container.innerHTML = ''; // Clear existing subcategories
                    
                    if (data.categories && data.categories.length > 0) {
                        data.categories.forEach(mainCat => {
                            if (mainCat.subcategories && mainCat.subcategories.length > 0) {
                                // Don't create main category header anymore
                                mainCat.subcategories.forEach(subcat => {
                                    const filterGroup = createSubcategoryGroup(subcat);
                                    container.appendChild(filterGroup);
                                });
                            }
                        });
                    }
                    // Always ensure the All Categories button is active
                    allCategoriesBtn.classList.add('active');
                })
                .catch(error => {
                    console.error('Error loading all subcategories:', error);
                    // In case of error, ensure All Categories button is active
                    allCategoriesBtn.classList.add('active');
                });
        }

        function loadSubSubcategories(subcatId, group) {
            fetch(`/get_subcategories/${subcatId}/`)
                .then(response => response.json())
                .then(subData => {
                    const subContainer = group.querySelector(`.subcategory-container-${subcatId}`);
                    subContainer.innerHTML = '';
                    if (subData.subcategories && subData.subcategories.length > 0) {
                        subData.subcategories.forEach(subSubcat => {
                            const subItem = createSubcategoryItem(subSubcat);
                            // Check if this sub-subcategory was previously selected
                            const filterClass = '.' + subSubcat.filter_class;
                            if (activeSubcategories.has(filterClass)) {
                                subItem.querySelector('.subcategory-checkbox').classList.add('checked');
                            }
                            subContainer.appendChild(subItem);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error loading sub-subcategories:', error);
                });
        }

        function createSubcategoryGroup(subcat) {
            const filterGroup = document.createElement('div');
            filterGroup.className = 'filter-group';
            
            const buttonContent = `
                <button class="filter-toggle" data-category-id="${subcat.id}" data-filter-class="${subcat.filter_class}">
                    <span>${subcat.name}</span>
                    ${subcat.has_children ? '<i class="fas fa-chevron-down toggle-arrow"></i>' : ''}
                </button>
                <div class="filter-options">
                    <div class="subcategory-container-${subcat.id} subcategory-group"></div>
                </div>
            `;
            
            filterGroup.innerHTML = buttonContent;
            
            // Add click event for the filter toggle
            const toggle = filterGroup.querySelector('.filter-toggle');
            toggle.addEventListener('click', function(e) {
                e.preventDefault();
                const group = this.closest('.filter-group');
                const wasOpen = group.classList.contains('open');
                group.classList.toggle('open');
                
                if (subcat.has_children && !wasOpen) {
                    loadSubSubcategories(subcat.id, group);
                }
            });
            
            return filterGroup;
        }

        function createSubcategoryItem(subcat) {
            const item = document.createElement('div');
            item.className = 'subcategory-item';
            item.dataset.categoryId = subcat.id;
            item.dataset.filterClass = '.' + subcat.filter_class;
            
            const checkbox = document.createElement('span');
            checkbox.className = 'subcategory-checkbox';
            
            const label = document.createElement('span');
            label.textContent = subcat.name;
            
            item.appendChild(checkbox);
            item.appendChild(label);
            
            item.addEventListener('click', function() {
                const isChecked = checkbox.classList.toggle('checked');
                const filterClass = this.dataset.filterClass;
                
                if (isChecked) {
                    activeSubcategories.add(filterClass);
                    // Remove highlight from All Categories button when selecting a sub-subcategory
                    allCategoriesBtn.classList.remove('active');
                } else {
                    activeSubcategories.delete(filterClass);
                    // If no subcategories are selected, highlight All Categories button
                    if (activeSubcategories.size === 0) {
                        allCategoriesBtn.classList.add('active');
                    }
                }
                
                updateFiltering();
            });
            
            return item;
        }

        function loadSubcategories(categoryId) {
            fetch(`/get_subcategories/${categoryId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    const container = document.getElementById('subcategories-container');
                    container.innerHTML = ''; // Clear existing subcategories
                    
                    if (data.subcategories && data.subcategories.length > 0) {
                        data.subcategories.forEach(subcat => {
                            const filterGroup = createSubcategoryGroup(subcat);
                            container.appendChild(filterGroup);
                        });
                    }
                    // Always ensure the All Categories button is active when there are no subcategories
                    allCategoriesBtn.classList.add('active');
                })
                .catch(error => {
                    console.error('Error loading subcategories:', error);
                    // In case of error, ensure All Categories button is active
                    allCategoriesBtn.classList.add('active');
                });
        }

        // Initial setup - only highlight "All" icon and show all subcategories
        const allCategory = document.querySelector('#portfolio-flters li[data-filter="*"]');
        if (allCategory) {
            // Remove any existing active classes first
            document.querySelectorAll('#portfolio-flters li').forEach(el => {
                el.classList.remove('filter-active');
            });
            // Add active class only to the "All" icon
            allCategory.classList.add('filter-active');
            // Load all subcategories on initial load
            loadAllSubcategories();
            allCategoriesBtn.classList.add('active');
        }
    });
</script>

{% endblock %}